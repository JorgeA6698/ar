<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AR MundiAR 2026</title>

  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

  <script>
    const animationMixers = new Map();
    
    AFRAME.registerComponent('change-flag-texture', {
      schema: { textureId: { type: 'string' } },
      init: function() {
        const self = this;
        let attempts = 0;
        const maxAttempts = 10;
        
        const tryChangeTexture = () => {
          const textureId = self.data.textureId;
          if (!textureId) return;
          
          const textureEl = document.querySelector(`#${textureId}`);
          if (!textureEl) return;
          
          const model = self.el.getObject3D('mesh');
          if (!model && attempts < maxAttempts) {
            attempts++;
            setTimeout(tryChangeTexture, 200);
            return;
          }
          
          if (!model) return;
          
          model.traverse((node) => {
            if (node.isMesh && node.material) {
              if (node.material.name === '01_-_Default' || 
                  (node.material.map && node.material.map.name && 
                   node.material.map.name.includes('Default_baseColor'))) {
                
                const texture = new THREE.Texture(textureEl);
                texture.needsUpdate = true;
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.anisotropy = 16;
                
                if (Array.isArray(node.material)) {
                  node.material = node.material.map(mat => mat.clone());
                  node.material.forEach(mat => {
                    if (mat.map) {
                      mat.map = texture;
                      mat.needsUpdate = true;
                    }
                  });
                } else {
                  node.material = node.material.clone();
                  node.material.map = texture;
                  node.material.needsUpdate = true;
                }
              }
            }
          });
        };
        
        this.el.addEventListener('model-loaded', tryChangeTexture);
        setTimeout(tryChangeTexture, 500);
      }
    });
    
    AFRAME.registerComponent('manual-animation', {
      init: function() {
        const el = this.el;
        const targetId = el.parentNode.getAttribute('id');
        
        let attempts = 0;
        const checkMixer = () => {
          const mixer = el.components['animation-mixer'];
          if (mixer && mixer.mixer) {
            mixer.mixer.timeScale = 0;
            animationMixers.set(targetId, mixer.mixer);
          } else if (attempts < 20) {
            attempts++;
            setTimeout(checkMixer, 200);
          }
        };
        
        el.addEventListener('model-loaded', () => setTimeout(checkMixer, 100));
      }
    });
  </script>

  <style>
    * {
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100vh;
      position: fixed;
      font-family: Arial, sans-serif;
    }

    #ar-scene {
      width: 100%;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1;
    }
    
    #home-button {
      position: fixed !important;
      bottom: 15px !important;
      left: 15px !important;
      width: 50px;
      height: 50px;
      background-color: rgba(255, 255, 255, 0.95);
      border: 2px solid #002868;
      border-radius: 50%;
      display: flex !important;
      align-items: center;
      justify-content: center;
      z-index: 999999 !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.1s ease;
      text-decoration: none;
      pointer-events: auto !important;
    }
    
    #home-button:active {
      transform: scale(0.85);
      background-color: #002868;
    }
    
    #home-button svg {
      width: 26px;
      height: 26px;
      fill: #002868;
    }
    
    #home-button:active svg {
      fill: white;
    }
    
    #button-container {
      position: fixed !important;
      bottom: 15px !important;
      right: 15px !important;
      z-index: 999998 !important;
      display: flex !important;
      flex-direction: column !important;
      gap: 10px;
      visibility: hidden;
    }
    
    .action-button {
      width: 55px;
      height: 55px;
      background-color: rgba(255, 255, 255, 0.95);
      border: 2px solid #002868;
      border-radius: 50%;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
      font-size: 22px;
      color: #002868;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s ease;
      touch-action: manipulation;
    }

    .action-button:active {
      background-color: #002868;
      transform: scale(0.85);
      color: white;
    }

    #animate-button {
      background-color: rgba(0, 200, 0, 0.95);
      border-color: #006400;
      color: white;
    }

    #animate-button:active {
      background-color: #006400;
    }
    
    #debug-info {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: lime;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 11px;
      z-index: 999997;
      max-width: 200px;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div id="debug-info">
    <div>Status: <span id="d-status">Cargando...</span></div>
    <div>Targets: <span id="d-targets">0</span></div>
    <div>Botones: <span id="d-buttons">ocultos</span></div>
  </div>

  <a href="index.html" id="home-button">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
    </svg>
  </a>

  <div id="button-container">
    <button class="action-button" id="animate-button">‚ñ∂Ô∏è</button>
    <button class="action-button" id="button2">üìä</button>
    <button class="action-button" id="button3">‚öôÔ∏è</button>
  </div>

  <a-scene
    id="ar-scene"
    mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 1; filterMinCF: 0.0001; filterBeta: 0.001; uiLoading: no"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    embedded
    renderer="colorManagement: true; physicallyCorrectLights: true;"
  >
    <a-assets>
      <a-asset-item id="flag-model" src="./mexico_flag/scene.gltf"></a-asset-item>
      <img id="mexico-texture" crossorigin="anonymous" src="./mexico_flag/textures/01_-_Default_baseColor.png">
      <img id="canada-texture" crossorigin="anonymous" src="./textures/canada_baseColor.png">
      <img id="usa-texture" crossorigin="anonymous" src="./textures/usa_basecolor.png">
      <img id="argentina-texture" crossorigin="anonymous" src="./textures/argentina_basecolor.jpg">
      <img id="brasil-texture" crossorigin="anonymous" src="./textures/brasil_basecolor.jpg">
      <img id="colombia-texture" crossorigin="anonymous" src="./textures/colombia_basecolor.jpg">
      <img id="paraguay-texture" crossorigin="anonymous" src="./textures/paraguay_basecolor.jpg">
      <img id="ecuador-texture" crossorigin="anonymous" src="./textures/ecuador_basecolor.jpg">
      <img id="uruguay-texture" crossorigin="anonymous" src="./textures/uruguay_basecolor.jpg">
      <img id="marruecos-texture" crossorigin="anonymous" src="./textures/marruecos_basecolor.jpg">
      <img id="tunez-texture" crossorigin="anonymous" src="./textures/tunez_basecolor.jpg">
      <img id="australia-texture" crossorigin="anonymous" src="./textures/australia_basecolor.jpg">
      <img id="iran-texture" crossorigin="anonymous" src="./textures/iran_basecolor.png">
      <img id="japon-texture" crossorigin="anonymous" src="./textures/japon_basecolor.png">
      <img id="jordania-texture" crossorigin="anonymous" src="./textures/jordania_basecolor.png">
      <img id="coreadelsur-texture" crossorigin="anonymous" src="./textures/coreadelsur_basecolor.jpg">
      <img id="uzbekistan-texture" crossorigin="anonymous" src="./textures/Uzbekistan_basecolor.png">
      <img id="nuevazelanda-texture" crossorigin="anonymous" src="./textures/nuevazelanda_basecolor.png">
    </a-assets>
    <a-camera position="0 0 0" look-controls="enabled: false" fov="65"></a-camera>
  </a-scene>

  <script>
    const $ = (id) => document.getElementById(id);
    const debug = (key, val) => {
      const el = $(`d-${key}`);
      if (el) el.textContent = val;
    };

    document.addEventListener('DOMContentLoaded', () => {
      const sceneEl = $('ar-scene');
      const buttonContainer = $('button-container');
      
      debug('status', 'Inicializado');

      const targetMap = [
        { start: 0, end: 3, textureId: 'mexico-texture' },        
        { start: 4, end: 6, textureId: 'canada-texture' },        
        { start: 7, end: 9, textureId: 'usa-texture' },           
        { start: 10, end: 12, textureId: 'argentina-texture' },   
        { start: 13, end: 16, textureId: 'brasil-texture' },      
        { start: 17, end: 21, textureId: 'colombia-texture' },    
        { start: 22, end: 25, textureId: 'paraguay-texture' },    
        { start: 26, end: 28, textureId: 'ecuador-texture' },     
        { start: 29, end: 33, textureId: 'uruguay-texture' },     
        { start: 34, end: 36, textureId: 'marruecos-texture' },   
        { start: 37, end: 39, textureId: 'tunez-texture' },       
        { start: 40, end: 42, textureId: 'australia-texture' },   
        { start: 43, end: 45, textureId: 'iran-texture' },        
        { start: 46, end: 49, textureId: 'japon-texture' },       
        { start: 50, end: 53, textureId: 'jordania-texture' },    
        { start: 54, end: 56, textureId: 'coreadelsur-texture' }, 
        { start: 57, end: 59, textureId: 'uzbekistan-texture' },  
        { start: 60, end: 63, textureId: 'nuevazelanda-texture' } 
      ];

      const getTextureIdForIndex = (index) => {
        for (const map of targetMap) {
          if (index >= map.start && index <= map.end) return map.textureId;
        }
        return null;
      };

      const allTargets = [];
      for (let i = 0; i <= 63; i++) {
        const textureId = getTextureIdForIndex(i);
        if (!textureId) continue;

        const targetEntity = document.createElement('a-entity');
        targetEntity.setAttribute('mindar-image-target', `targetIndex: ${i}`);
        targetEntity.setAttribute('id', `target-${i}`);
        
        const flagModel = document.createElement('a-entity');
        flagModel.setAttribute('gltf-model', '#flag-model');
        flagModel.setAttribute('animation-mixer', '');
        flagModel.setAttribute('manual-animation', '');
        flagModel.setAttribute('scale', '0.0005 0.0005 0.0005');
        flagModel.setAttribute('position', '0 0 0');
        flagModel.setAttribute('change-flag-texture', `textureId: ${textureId}`);

        targetEntity.appendChild(flagModel);
        sceneEl.appendChild(targetEntity);
        allTargets.push({entity: targetEntity, index: i, id: `target-${i}`});
      }

      let isAnimating = false;
      let currentVisibleTarget = null;

      // POLLING - Verificar visibilidad cada 200ms
      setInterval(() => {
        let foundVisible = false;
        
        for (const target of allTargets) {
          const flagEl = target.entity.querySelector('[gltf-model]');
          if (flagEl && flagEl.object3D && flagEl.entity.object3D.visible) {
            foundVisible = true;
            
            if (currentVisibleTarget !== target.id) {
              currentVisibleTarget = target.id;
              debug('status', `Target ${target.index} VISIBLE`);
              debug('targets', '1');
              debug('buttons', 'VISIBLES');
              
              buttonContainer.style.visibility = 'visible';
              isAnimating = false;
              $('animate-button').textContent = '‚ñ∂Ô∏è';
            }
            break;
          }
        }
        
        if (!foundVisible && currentVisibleTarget) {
          currentVisibleTarget = null;
          debug('status', 'Sin target');
          debug('targets', '0');
          debug('buttons', 'ocultos');
          buttonContainer.style.visibility = 'hidden';
          isAnimating = false;
        }
      }, 200);

      $('animate-button').addEventListener('click', () => {
        if (!currentVisibleTarget) return;
        
        const mixer = animationMixers.get(currentVisibleTarget);
        if (mixer) {
          if (!isAnimating) {
            mixer.timeScale = 1;
            isAnimating = true;
            $('animate-button').textContent = '‚è∏Ô∏è';
            debug('status', 'ANIMANDO');
          } else {
            mixer.timeScale = 0;
            isAnimating = false;
            $('animate-button').textContent = '‚ñ∂Ô∏è';
            debug('status', 'PAUSADO');
          }
        }
      });

      $('button2').addEventListener('click', () => alert('Informaci√≥n'));
      $('button3').addEventListener('click', () => alert('Opciones'));
    });
  </script>
</body>
</html>
