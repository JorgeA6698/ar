<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AR MundiAR 2026</title>

  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

  <script>
    // Variable global para almacenar los mixers de animaci√≥n
    const animationMixers = new Map();
    
    // Componente personalizado para cambiar la textura del modelo GLTF
    AFRAME.registerComponent('change-flag-texture', {
      schema: {
        textureId: { type: 'string' }
      },
      init: function() {
        const self = this;
        let attempts = 0;
        const maxAttempts = 10;
        
        const tryChangeTexture = () => {
          const textureId = self.data.textureId;
          if (!textureId) return;
          
          const textureEl = document.querySelector(`#${textureId}`);
          if (!textureEl) {
            console.error(`Textura no encontrada: ${textureId}`);
            return;
          }
          
          const model = self.el.getObject3D('mesh');
          if (!model && attempts < maxAttempts) {
            attempts++;
            setTimeout(tryChangeTexture, 200);
            return;
          }
          
          if (!model) {
            console.error('No se pudo cargar el modelo');
            return;
          }
          
          let textureChanged = false;
          
          model.traverse((node) => {
            if (node.isMesh && node.material) {
              if (node.material.name === '01_-_Default' || 
                  (node.material.map && node.material.map.name && 
                   node.material.map.name.includes('Default_baseColor'))) {
                
                const texture = new THREE.Texture(textureEl);
                texture.needsUpdate = true;
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.anisotropy = 16;
                
                if (Array.isArray(node.material)) {
                  node.material = node.material.map(mat => mat.clone());
                  node.material.forEach(mat => {
                    if (mat.map) {
                      mat.map = texture;
                      mat.needsUpdate = true;
                    }
                  });
                } else {
                  node.material = node.material.clone();
                  node.material.map = texture;
                  node.material.needsUpdate = true;
                }
                
                textureChanged = true;
                console.log(`Textura cambiada a: ${textureId}`);
              }
            }
          });
          
          if (!textureChanged) {
            console.warn(`No se encontr√≥ el material de la bandera para ${textureId}`);
          }
        };
        
        this.el.addEventListener('model-loaded', tryChangeTexture);
        setTimeout(tryChangeTexture, 500);
      }
    });
    
    // Componente personalizado para controlar la animaci√≥n manualmente
    AFRAME.registerComponent('manual-animation', {
      init: function() {
        const el = this.el;
        const targetId = el.parentNode.getAttribute('id');
        
        // Intentar m√∫ltiples veces hasta que el mixer est√© disponible
        let attempts = 0;
        const maxAttempts = 20;
        
        const checkMixer = () => {
          const mixer = el.components['animation-mixer'];
          
          if (mixer && mixer.mixer) {
            // Pausar la animaci√≥n al inicio
            mixer.mixer.timeScale = 0;
            animationMixers.set(targetId, mixer.mixer);
            console.log(`‚úÖ Animaci√≥n pausada y registrada para ${targetId}`);
          } else if (attempts < maxAttempts) {
            attempts++;
            setTimeout(checkMixer, 200);
          } else {
            console.warn(`‚ö†Ô∏è No se pudo encontrar mixer para ${targetId}`);
          }
        };
        
        // Esperar a que el modelo se cargue
        el.addEventListener('model-loaded', () => {
          setTimeout(checkMixer, 100);
        });
      }
    });
  </script>

  <style>
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100vh;
      position: fixed;
      font-family: Arial, sans-serif;
    }

    #ar-scene {
      width: 100%;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1;
    }
    
    /* Bot√≥n de Home optimizado para m√≥vil */
    #home-button {
      position: fixed !important;
      bottom: 15px !important;
      left: 15px !important;
      width: 50px;
      height: 50px;
      background-color: rgba(255, 255, 255, 0.95);
      border: 2px solid #002868;
      border-radius: 50%;
      display: flex !important;
      align-items: center;
      justify-content: center;
      z-index: 999999 !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.1s ease;
      text-decoration: none;
      pointer-events: auto !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    #home-button:active {
      transform: scale(0.85);
      background-color: #002868;
    }
    
    #home-button svg {
      width: 26px;
      height: 26px;
      fill: #002868;
      transition: fill 0.1s ease;
    }
    
    #home-button:active svg {
      fill: white;
    }
    
    /* Contenedor de botones de acci√≥n */
    #button-container {
      position: fixed;
      bottom: 15px;
      right: 15px;
      z-index: 100000 !important;
      display: flex !important;
      flex-direction: column; 
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
      gap: 10px;
      pointer-events: none;
    }
    
    #button-container.visible {
      visibility: visible !important;
      opacity: 1 !important;
      pointer-events: auto !important;
    }
    
    /* Botones de acci√≥n optimizados para m√≥vil */
    .action-button {
      width: 55px;
      height: 55px;
      background-color: rgba(255, 255, 255, 0.95);
      border: 2px solid #002868;
      border-radius: 50%;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
      font-size: 22px;
      color: #002868;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s ease;
      touch-action: manipulation;
    }

    .action-button:active {
      background-color: #002868;
      transform: scale(0.85);
      color: white;
    }

    /* Bot√≥n de animaci√≥n especial */
    #animate-button {
      background-color: rgba(0, 200, 0, 0.95);
      border-color: #006400;
      color: white;
      font-size: 20px;
    }

    #animate-button:active {
      background-color: #006400;
    }
    
    /* Estilos para el recuadro de escaneo */
    .mindar-ui-scanning {
      display: block !important;
      transition: opacity 0.3s ease;
      position: fixed !important;
      top: 50% !important;
      left: 40% !important;
      transform: translate(-50%, -50%) !important;
   
    }
    
    .mindar-ui-scanning.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    /* Debug en pantalla */
    #debug-info {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.8);
      color: #00ff00;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      z-index: 999998;
      max-width: 90%;
      pointer-events: none;
    }
    
    #debug-info div {
      margin: 2px 0;
    }
    canvas {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>

  <!-- Debug visual en pantalla -->
  <div id="debug-info">
    <div id="debug-status">Iniciando...</div>
    <div id="debug-targets">Targets: 0</div>
    <div id="debug-buttons">Botones: ocultos</div>
    <div id="debug-mixer">Mixer: N/A</div>
  </div>

  <a href="index.html" id="home-button" title="Volver al inicio" aria-label="Inicio">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
    </svg>
  </a>

  <div id="button-container">
    <button class="action-button" id="animate-button" aria-label="Animar bandera">‚ñ∂Ô∏è</button>
    <button class="action-button" id="button2" aria-label="Informaci√≥n">üìä</button>
    <button class="action-button" id="button3" aria-label="Opciones">‚öôÔ∏è</button>
  </div>

  <a-scene
    id="ar-scene"
    mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 1; filterMinCF: 0.0001; filterBeta: 0.001; uiLoading: no"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    embedded
    renderer="colorManagement: true; physicallyCorrectLights: true;"
  >
    <a-assets>
      <a-asset-item id="flag-model" src="./mexico_flag/scene.gltf"></a-asset-item>

      <img id="mexico-texture" crossorigin="anonymous" src="./mexico_flag/textures/01_-_Default_baseColor.png">
      <img id="canada-texture" crossorigin="anonymous" src="./textures/canada_baseColor.png">
      <img id="usa-texture" crossorigin="anonymous" src="./textures/usa_basecolor.png">
      
      <img id="argentina-texture" crossorigin="anonymous" src="./textures/argentina_basecolor.jpg">
      <img id="brasil-texture" crossorigin="anonymous" src="./textures/brasil_basecolor.jpg">
      <img id="colombia-texture" crossorigin="anonymous" src="./textures/colombia_basecolor.jpg">
      <img id="paraguay-texture" crossorigin="anonymous" src="./textures/paraguay_basecolor.jpg">
      <img id="ecuador-texture" crossorigin="anonymous" src="./textures/ecuador_basecolor.jpg">
      <img id="uruguay-texture" crossorigin="anonymous" src="./textures/uruguay_basecolor.jpg">
      
      <img id="marruecos-texture" crossorigin="anonymous" src="./textures/marruecos_basecolor.jpg">
      <img id="tunez-texture" crossorigin="anonymous" src="./textures/tunez_basecolor.jpg">
      
      <img id="australia-texture" crossorigin="anonymous" src="./textures/australia_basecolor.jpg">
      <img id="iran-texture" crossorigin="anonymous" src="./textures/iran_basecolor.png">
      <img id="japon-texture" crossorigin="anonymous" src="./textures/japon_basecolor.png">
      <img id="jordania-texture" crossorigin="anonymous" src="./textures/jordania_basecolor.png">
      <img id="coreadelsur-texture" crossorigin="anonymous" src="./textures/coreadelsur_basecolor.jpg">
      <img id="uzbekistan-texture" crossorigin="anonymous" src="./textures/Uzbekistan_basecolor.png">
      
      <img id="nuevazelanda-texture" crossorigin="anonymous" src="./textures/nuevazelanda_basecolor.png">
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false" fov="65"></a-camera>

  </a-scene>

  <script>
    // Sistema de debug visual
    function updateDebug(key, value) {
      const debugEl = document.getElementById(`debug-${key}`);
      if (debugEl) {
        debugEl.textContent = `${key}: ${value}`;
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const sceneEl = document.querySelector('a-scene');
      const buttonContainer = document.getElementById('button-container');
      
      updateDebug('status', 'Cargando escena...');
      
      // Verificar que los elementos existan
      if (!buttonContainer) {
        updateDebug('status', 'ERROR: buttonContainer no existe!');
        return;
      }
      
      updateDebug('status', 'Elementos encontrados');
      
      // Mapeo de √≠ndices a IDs de textura
      const targetMap = [
        { start: 0, end: 3, textureId: 'mexico-texture' },        
        { start: 4, end: 6, textureId: 'canada-texture' },        
        { start: 7, end: 9, textureId: 'usa-texture' },           
        { start: 10, end: 12, textureId: 'argentina-texture' },   
        { start: 13, end: 16, textureId: 'brasil-texture' },      
        { start: 17, end: 21, textureId: 'colombia-texture' },    
        { start: 22, end: 25, textureId: 'paraguay-texture' },    
        { start: 26, end: 28, textureId: 'ecuador-texture' },     
        { start: 29, end: 33, textureId: 'uruguay-texture' },     
        { start: 34, end: 36, textureId: 'marruecos-texture' },   
        { start: 37, end: 39, textureId: 'tunez-texture' },       
        { start: 40, end: 42, textureId: 'australia-texture' },   
        { start: 43, end: 45, textureId: 'iran-texture' },        
        { start: 46, end: 49, textureId: 'japon-texture' },       
        { start: 50, end: 53, textureId: 'jordania-texture' },    
        { start: 54, end: 56, textureId: 'coreadelsur-texture' }, 
        { start: 57, end: 59, textureId: 'uzbekistan-texture' },  
        { start: 60, end: 63, textureId: 'nuevazelanda-texture' } 
      ];

      function getTextureIdForIndex(index) {
        for (const map of targetMap) {
          if (index >= map.start && index <= map.end) {
            return map.textureId;
          }
        }
        return null;
      }

      // Generar din√°micamente todos los targets
      const allTargets = [];
      for (let i = 0; i <= 63; i++) {
        const textureId = getTextureIdForIndex(i);
        if (!textureId) continue; 

        const targetEntity = document.createElement('a-entity');
        targetEntity.setAttribute('mindar-image-target', `targetIndex: ${i}`);
        targetEntity.setAttribute('id', `target-${i}`);
        
        const flagModel = document.createElement('a-entity');
        flagModel.setAttribute('gltf-model', '#flag-model');
        flagModel.setAttribute('animation-mixer', '');
        flagModel.setAttribute('manual-animation', '');
        
        // Escala optimizada para m√≥vil
        flagModel.setAttribute('scale', '0.0005 0.0005 0.0005'); 
        flagModel.setAttribute('position', '0 0 0');
        flagModel.setAttribute('rotation', '0 0 0');
        flagModel.setAttribute('change-flag-texture', `textureId: ${textureId}`);
        flagModel.setAttribute('data-target-index', i);

        targetEntity.appendChild(flagModel);
        sceneEl.appendChild(targetEntity);
        allTargets.push(targetEntity);
      }
      
      const activeTargets = new Set();
      
      // Controlar visibilidad del UI de escaneo
      const updateScanningUI = () => {
        const scanningUI = document.querySelector('.mindar-ui-scanning');
        if (scanningUI) {
          if (activeTargets.size === 0) {
            scanningUI.classList.remove('hidden');
            scanningUI.style.display = 'block';
            scanningUI.style.opacity = '1';
          } else {
            scanningUI.classList.add('hidden');
            scanningUI.style.opacity = '0';
            setTimeout(() => {
              if (activeTargets.size > 0) {
                scanningUI.style.display = 'none';
              }
            }, 300);
          }
        }
      };
      
      setInterval(() => {
        const scanningUI = document.querySelector('.mindar-ui-scanning');
        if (scanningUI && activeTargets.size === 0) {
          scanningUI.style.display = 'block';
          scanningUI.style.opacity = '1';
        }
      }, 500);
      
      // L√≥gica de targetFound/targetLost
      let isAnimating = false;
      
      allTargets.forEach((target) => {
        const targetIndexMatch = target.getAttribute('mindar-image-target').match(/targetIndex: (\d+)/);
        if (!targetIndexMatch) return;
        const targetIndex = parseInt(targetIndexMatch[1]);

        target.addEventListener('targetFound', () => {
          const targetId = `target-${targetIndex}`;
          activeTargets.add(targetIndex);
          
          updateDebug('status', `Target ${targetIndex} DETECTADO!`);
          updateDebug('targets', activeTargets.size);
          
          // FORZAR visibilidad de botones de m√∫ltiples formas
          buttonContainer.className = 'visible';
          buttonContainer.style.visibility = 'visible';
          buttonContainer.style.display = 'flex';
          buttonContainer.style.opacity = '1';
          buttonContainer.style.pointerEvents = 'auto';
          buttonContainer.style.zIndex = '100000';
          
          updateDebug('buttons', 'VISIBLES');
          
          // Resetear estado de animaci√≥n
          isAnimating = false;
          document.getElementById('animate-button').textContent = '‚ñ∂Ô∏è';
          
          // Verificar si el mixer est√° disponible
          setTimeout(() => {
            const mixer = animationMixers.get(targetId);
            updateDebug('mixer', mixer ? 'DISPONIBLE' : 'NO DISPONIBLE');
          }, 500);
          
          updateScanningUI();
        });

        target.addEventListener('targetLost', () => {
          activeTargets.delete(targetIndex);
          
          updateDebug('status', `Target ${targetIndex} perdido`);
          updateDebug('targets', activeTargets.size);
          
          if (activeTargets.size === 0) {
            // Ocultar botones
            buttonContainer.className = '';
            buttonContainer.style.visibility = 'hidden';
            buttonContainer.style.display = 'flex';
            buttonContainer.style.opacity = '0';
            buttonContainer.style.pointerEvents = 'none';
            
            updateDebug('buttons', 'ocultos');
            
            // Pausar animaci√≥n
            const targetId = `target-${targetIndex}`;
            const mixer = animationMixers.get(targetId);
            if (mixer) {
              mixer.timeScale = 0;
            }
            isAnimating = false;
            updateDebug('mixer', 'pausado');
          }
          updateScanningUI();
        });
      });
      
      // Funcionalidad del bot√≥n de animaci√≥n
      document.getElementById('animate-button').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        updateDebug('status', 'Click en ANIMAR');
        
        if (activeTargets.size > 0) {
          const activeTargetIndex = Array.from(activeTargets)[0];
          const targetId = `target-${activeTargetIndex}`;
          const mixer = animationMixers.get(targetId);
          
          if (mixer) {
            if (!isAnimating) {
              mixer.timeScale = 1;
              isAnimating = true;
              document.getElementById('animate-button').textContent = '‚è∏Ô∏è';
              updateDebug('mixer', 'REPRODUCIENDO');
            } else {
              mixer.timeScale = 0;
              isAnimating = false;
              document.getElementById('animate-button').textContent = '‚ñ∂Ô∏è';
              updateDebug('mixer', 'PAUSADO');
            }
          } else {
            updateDebug('mixer', 'ERROR: No disponible');
          }
        } else {
          updateDebug('status', 'No hay targets activos');
        }
      });
      
      // Otros botones
      document.getElementById('button2').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        updateDebug('status', 'Click en Bot√≥n 2');
        alert('Informaci√≥n de la bandera');
      });
      
      document.getElementById('button3').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        updateDebug('status', 'Click en Bot√≥n 3');
        alert('M√°s opciones');
      });
      
      
      // Prueba inicial - forzar botones visibles por 3 segundos para verificar
      updateDebug('status', 'Prueba: mostrando botones 3s');
      buttonContainer.style.visibility = 'visible';
      buttonContainer.style.display = 'flex';
      buttonContainer.style.opacity = '1';
      buttonContainer.style.pointerEvents = 'auto';
      
      setTimeout(() => {
        if (activeTargets.size === 0) {
          buttonContainer.style.visibility = 'hidden';
          buttonContainer.style.opacity = '0';
          buttonContainer.style.pointerEvents = 'none';
          updateDebug('status', 'Esperando target...');
        }
      }, 3000);
      
      // Asegurar visibilidad del bot√≥n home
      const homeButton = document.getElementById('home-button');
      if (homeButton) {
        homeButton.style.visibility = 'visible';
        homeButton.style.display = 'flex';
        homeButton.style.position = 'fixed';
        homeButton.style.zIndex = '999999';
      }
      
      setTimeout(() => {
        const scanningUI = document.querySelector('.mindar-ui-scanning');
        if (scanningUI) {
          scanningUI.style.position = 'fixed';
          scanningUI.style.top = '50%';
          scanningUI.style.left = '50%';
          scanningUI.style.transform = 'translate(-50%, -50%)';
          scanningUI.style.zIndex = '10000';
        }
      }, 1000);
    });
  </script>
</body>
</html>
